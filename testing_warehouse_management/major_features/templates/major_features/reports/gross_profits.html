{% extends "major_features/layout.html" %}

{% load static %}

{% load humanize %}

{% block nav %}
<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #01257D;">
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: white;" href="{% url 'index' %}">Trang chủ</a>
      </li>
      <li class="nav-item dropdown-trigger" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: white;" href="{% url 'import_shipments' %}">Nhập kho</a>
        <ul class="dropdown-ul">
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'import_shipments' %}" style="color: white; text-decoration: none;">
              Theo dõi lô hàng nhập kho
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'import_action' %}" style="color: white; text-decoration: none;">
              Thực hiện nhập kho
            </a>
          </li>
        </ul>
      </li>
      <li class="nav-item dropdown-trigger" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: white;" href="{% url 'export_shipments' %}">Xuất kho</a>
        <ul class="dropdown-ul">
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'export_shipments' %}" style="color: white; text-decoration: none;">
              Theo dõi lô hàng xuất kho
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'export_action' %}" style="color: white; text-decoration: none;">
              Thực hiện xuất kho
            </a>
          </li>
        </ul>
      </li>
      <li class="nav-item dropdown-trigger" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: #00FFFF; border-bottom: 2px solid #00FFFF;" href="{% url 'reports_revenue' %}">Thống kê</a>
        <ul class="dropdown-ul">
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'reports_revenue' %}" style="color: white; text-decoration: none;">
              Doanh thu
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'reports_gross_profits' %}" style="color: white; text-decoration: none;">
              Lợi nhuận
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'reports_import_section' %}" style="color: white; text-decoration: none;">
              Nhập kho
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'reports_export_section' %}" style="color: white; text-decoration: none;">
              Xuất kho
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </div>
</nav>
{% endblock %}

{% block title %}
<h3 style="margin-top: 10px; text-align: center;">Thống kê lợi nhuận</h3>
{% endblock %}

{% block body %}

<div class="d-flex flex-row">
  <div class="dropdown">
    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
      {{ chosen_period_name }}
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1" id="period-type">

      {% for key, item in unchosen_period_types.items %}
      <li><a class="dropdown-item" href="?period_type={{ key }}">{{ item }}</a></li>
      {% endfor %}
      
    </ul>
  </div>

  <form action="{% url 'reports_gross_profits' %}" class="inline-form" method="GET">
    <input type="hidden" name="period_type" value="{{ chosen_period_type }}">
    {% if chosen_period_type == 'accounting_period' %}
    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div>
      <select name="{{ chosen_period_type }}" class="form-select select form-select-md" id="{{ chosen_period_type }}">
        {% for period in all_accounting_period %}

        {% if period.id == chosen_accounting_period_id %}
        <option value="{{ period.id }}" selected>
          {{ period.warehouse_management_method }} từ {{ period.date_applied|date:"d/m/Y" }} đến {{ period.date_end|date:"d/m/Y" }}
        </option>
        {% else %}
        <option value="{{ period.id }}">
          {{ period.warehouse_management_method }} từ {{ period.date_applied|date:"d/m/Y" }} đến {{ period.date_end|date:"d/m/Y" }}
        </option>
        {% endif %}

        {% endfor %}
      </select>
    </div>
    <button type="submit" class="btn btn-secondary btn-sm inline-margin" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'year' %}
    <label for="{{ chosen_period_type }}"  class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <input type="number" name="{{ chosen_period_type }}" value="{{ chosen_year }}" class="form-select select form-select-md inline-margin" id="{{ chosen_period_type }}">
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'quarter' %}
    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <select name="{{ chosen_period_type }}" class="form-select select form-select-md inline-margin" id="{{ chosen_period_type }}">
        {% for quarter, value in quarters.items %}
        {% if quarter == chosen_quarter %}
        <option value="{{ quarter }}" selected>{{ value.quarter_name }}</option>
        {% else %}
        <option value="{{ quarter }}">{{ value.quarter_name }}</option>
        {% endif %}
        {% endfor %}
      </select>
      <label for="quarter_year" class="col-form-label inline-margin">Năm: </label>
      <input type="number" class="form-control inline-margin" name="quarter_year" required id="quarter_year" placeholder="yyyy" value="{{ chosen_year }}" min="0">
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'month' %}
    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <select name="{{ chosen_period_type }}" class="form-select select form-select-md" id="{{ chosen_period_type }} required">
        {% for month, value in months.items %}
          {% if month == chosen_month %}
          <option value="{{ month }}" selected>{{ value }}</option>
          {% else %}
          <option value="{{ month }}">{{ value }}</option>
          {% endif %}
        {% endfor %}
      </select>
      <label for="month_year" class="col-form-label inline-margin">Năm: </label>
      <input type="number" class="form-control inline-margin" name="month_year" required id="month_year" placeholder="yyyy" value="{{ chosen_month_year }}" min="0">
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'day' %}

    {% if chosen_date %}
    <p>{{ chosen_date|date:"d/m/Y" }}</p>
    {% endif %}

    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <input type="date" name="{{ chosen_period_type }}" class="form-control inline-margin" value='{{ chosen_date|date:"m/d/Y" }}' id="{{ chosen_period_type }}">
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>

    {% endif %}
  </form>
</div>

{% if not non_period_found_msg %}
<div class="d-flex justify-content-center" style="margin-top: 20px !important;">
  <table class="table table-bordered table-striped table-dark w-auto" style="margin: auto;">
    <caption>Thống kê lợi nhuận từng sản phẩm</caption>
    <thead>
      <tr>
        <th scope="col">Sản phẩm</th>
        <th scope="col">Lợi nhuận</th>
      </tr>
    </thead>
    <tbody>
      {% for product_gross_profits in products_gross_profits %}
      <tr>
        <td>{{ product_gross_profits.product_id__name }}</td>
        <td style="text-align: right;">{{ product_gross_profits.gross_profits|intcomma }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td style="color: #00FFFF"><strong>Tổng</strong></td>
        <td style="color: #00FFFF; text-align: right;">{{ total_gross_profits|intcomma }}</td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Google chart -->
<div class="d-flex justify-content-around">
  <div id="gross_profits_columnchart"></div>
</div>

{% else %}
<div>
  <p>
    <strong>{{ non_period_found_msg }}</strong>
  </p>
</div>
{% endif %}

{% endblock %}

{% block script %}
<script src="{% static 'major_features/major_features_js/reports/reports.js' %}"></script>

{% if not non_period_found_msg %}

{{ gross_profits_arr|json_script:"gross_profits_arr" }}

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load("current", {packages:['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    const GROSS_PROFITS = JSON.parse(document.getElementById('gross_profits_arr').textContent);

    function drawChart() {
      var gross_profits_data = google.visualization.arrayToDataTable(GROSS_PROFITS)

      var gross_profits_view = new google.visualization.DataView(gross_profits_data);

      var default_settings = [0, 1,
                       { calc: "stringify",
                         sourceColumn: 1,
                         type: "string",
                         role: "annotation" },
                       2]

      gross_profits_view.setColumns(default_settings);

      var default_options = {
        title: "",
        width: 500,
        height: 400,
        bar: {groupWidth: "95%"},
        legend: { position: "none" },
      };

      var gross_profits_options = default_options;
      gross_profits_options["title"] = "Lợi nhuận của từng sản phẩm trong kỳ";

      var gross_profits_chart = new google.visualization.ColumnChart(document.getElementById("gross_profits_columnchart"));
      gross_profits_chart.draw(gross_profits_view, gross_profits_options);
  }
</script>

{% endif %}

{% endblock %}