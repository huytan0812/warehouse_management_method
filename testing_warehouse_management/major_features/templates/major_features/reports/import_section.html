{% extends "major_features/layout.html" %}

{% load static %}

{% load humanize %}

{% block nav %}
<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #01257D;">
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: white;" href="{% url 'index' %}">Trang chủ</a>
      </li>
      <li class="nav-item dropdown-trigger" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: white;" href="{% url 'import_shipments' %}">Nhập kho</a>
        <ul class="dropdown-ul">
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'import_shipments' %}" style="color: white; text-decoration: none;">
              Theo dõi lô hàng nhập kho
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'import_action' %}" style="color: white; text-decoration: none;">
              Thực hiện nhập kho
            </a>
          </li>
        </ul>
      </li>
      <li class="nav-item dropdown-trigger" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: white;" href="{% url 'export_shipments' %}">Xuất kho</a>
        <ul class="dropdown-ul">
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'export_shipments' %}" style="color: white; text-decoration: none;">
              Theo dõi lô hàng xuất kho
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'export_action' %}" style="color: white; text-decoration: none;">
              Thực hiện xuất kho
            </a>
          </li>
        </ul>
      </li>
      <li class="nav-item dropdown-trigger" style="padding: 2.5px 5px 2.5px 5px;">
        <a class="nav-link" style="color: #00FFFF; border-bottom: 2px solid #00FFFF;" href="{% url 'reports_revenue' %}">Thống kê</a>
        <ul class="dropdown-ul">
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'reports_revenue' %}" style="color: white; text-decoration: none;">
              Doanh thu
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'reports_import_section' %}" style="color: white; text-decoration: none;">
              Nhập kho
            </a>
          </li>
          <li class="nav-item dropdown-li">
            <a class="nav-link" href="{% url 'reports_export_section' %}" style="color: white; text-decoration: none;">
              Xuất kho
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </div>
</nav>
{% endblock %}

{% block title %}
<h3 style="margin-top: 10px; text-align: center;">Thống kê hàng hóa nhập kho</h3>
{% endblock %}

{% block body %}
<div class="d-flex flex-row">
  <div class="dropdown">
    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
      {{ chosen_period_name }}
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1" id="period-type">

      {% for key, item in unchosen_period_types.items %}
      <li><a class="dropdown-item" href="?period_type={{ key }}">{{ item }}</a></li>
      {% endfor %}
      
    </ul>
  </div>

  <form action="{% url 'reports_import_section' %}" class="inline-form" method="GET">
    <input type="hidden" name="period_type" value="{{ chosen_period_type }}">
    {% if chosen_period_type == 'accounting_period' %}
    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div>
      <select name="{{ chosen_period_type }}" class="form-select select form-select-md" id="{{ chosen_period_type }}">
        <option value="accounting_period">Kỳ kế toán</option>
      </select>
    </div>
    <button type="submit" class="btn btn-secondary btn-sm inline-margin" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'year' %}
    <label for="{{ chosen_period_type }}"  class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <select name="{{ chosen_period_type }}" class="form-select select form-select-md inline-margin" id="{{ chosen_period_type }}">
        <option value="2023">2023</option>
      </select>
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'quarter' %}
    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <select name="{{ chosen_period_type }}" class="form-select select form-select-md inline-margin" id="{{ chosen_period_type }}">
        <option value="quarter3">Quý 3</option>
      </select>
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'month' %}
    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <select name="{{ chosen_period_type }}" class="form-select select form-select-md" id="{{ chosen_period_type }}">
        {% for month, value in months.items %}
          {% if month == request.GET.month %}
          <option value="{{ month }}" selected>{{ value }}</option>
          {% else %}
          <option value="{{ month }}">{{ value }}</option>
          {% endif %}
        {% endfor %}
      </select>
      <label for="month_year" class="col-form-label inline-margin">Năm: </label>
      <input type="text" class="form-control inline-margin" name="month_year" id="month_year" placeholder="yyyy" value="{{ request.GET.month_year }}" min="0">
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}

    {% if chosen_period_type == 'day' %}
    <label for="{{ chosen_period_type }}" class="col-form-label inline-margin">{{ chosen_period_name }}: </label>
    <div class="d-flex flex-row">
      <input type="date" name="{{ chosen_period_type }}" class="form-control inline-margin" id="{{ chosen_period_type }}" placeholder="dd/mm/yyyy">
    </div>
    <button type="submit" class="btn btn-secondary btn-sm" style="font-size: 1rem;">Xác nhận</button>
    {% endif %}
  </form>
</div>

<div class="d-flex justify-content-center" style="margin-top: 15px !important;">
  <table class="table table-bordered table-striped table-dark w-auto" style="margin: auto;">
    <caption>Thống kê hàng hóa nhập kho</caption>
    <thead>
      <tr>
        <th scope="col">Sản phẩm</th>
        <th scope="col">Số lượng nhập kho</th>
        <th scope="col">Giá trị nhập kho</th>
      </tr>
    </thead>
    <tbody>
      {% for product_inventory in products_inventory %}
      <tr>
        <td>{{ product_inventory.product_id.name }}</td>
        <td style="text-align: right;">{{product_inventory.import_quantity|intcomma }}</td>
        <td style="text-align: right;">{{product_inventory.import_inventory|intcomma }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td style="color: #00FFFF"><strong>Tổng</strong></td>
        <td style="color: #00FFFF; text-align: right;">{{ total_import_quantity|intcomma }}</td>
        <td style="color: #00FFFF; text-align: right;">{{ total_import_inventory|intcomma }}</td>
      </tr>
    </tfoot>
  </table>
</div>

<div class="d-flex justify-content-around">
  <div id="import_inventory_columnchart"></div>
  <div id="import_quantity_columnchart"></div>
</div>

{% endblock %}

{% block script %}
<script src="{% static 'major_features/major_features_js/reports/import_section.js' %}"></script>
{{ import_inventory_data_arr|json_script:"import_inventory_data_arr" }}
{{ import_quantity_data_arr|json_script:"import_quantity_data_arr" }}

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load("current", {packages:['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    const IMPORT_INVENTORY_DATA_ARR = JSON.parse(document.getElementById('import_inventory_data_arr').textContent);
    const IMPORT_QUANTITY_DATA_ARR = JSON.parse(document.getElementById('import_quantity_data_arr').textContent);

    function drawChart() {
      var import_inventory_data = google.visualization.arrayToDataTable(IMPORT_INVENTORY_DATA_ARR)
      var import_quantity_data = google.visualization.arrayToDataTable(IMPORT_QUANTITY_DATA_ARR);

      var inventory_view = new google.visualization.DataView(import_inventory_data);
      var quantity_view = new google.visualization.DataView(import_quantity_data);

      var default_settings = [0, 1,
                       { calc: "stringify",
                         sourceColumn: 1,
                         type: "string",
                         role: "annotation" },
                       2]

      inventory_view.setColumns(default_settings);
      quantity_view.setColumns(default_settings);

      var default_options = {
        title: "",
        width: 500,
        height: 400,
        bar: {groupWidth: "95%"},
        legend: { position: "none" },
      };

      var inventory_options = default_options;
      inventory_options["title"] = "Giá trị nhập kho của từng sản phẩm trong kỳ";

      var import_inventory_chart = new google.visualization.ColumnChart(document.getElementById("import_inventory_columnchart"));
      import_inventory_chart.draw(inventory_view, inventory_options);

      var quantity_options = default_options;
      quantity_options["title"] = "Số lượng nhập kho của từng sản phẩm trong kỳ";

      var import_quantity_chart = new google.visualization.ColumnChart(document.getElementById("import_quantity_columnchart"));
      import_quantity_chart.draw(quantity_view, quantity_options);
  }
</script>
{% endblock %}